---
- hosts: "localhost"
  connection: "local"
  gather_facts: false

  pre_tasks:
    - name: Validate Input
      assert:
        that:
        - aws_access_key is defined
        - aws_secret_key is defined
        - region is defined
        - api_id is defined
        - stage_name is defined

  tasks:
    - name: Check ansible version
      when: (ansible_version.major == 2 and ansible_version.minor < 8 ) or (ansible_version.major < 2)
      run_once: yes
      fail:
        msg: Please use Ansible 2.8 or newer

    - name: Get Swagger File
      shell: >
        AWS_ACCESS_KEY_ID="{{aws_access_key}}" AWS_SECRET_ACCESS_KEY="{{ aws_secret_key }}" aws apigateway get-export --parameters extensions='apigateway' --rest-api-id {{api_id}} --stage-name {{stage_name}} --export-type swagger ./files/swagger.json --region "{{region}}"
      register: swagger_file
      failed_when: swagger_file.stderr_lines
    - debug: var=swagger_file


    - name: Enable X-Tray Tracing
      community.aws.aws_api_gateway:
        api_id: "{{api_id}}"
        region: "{{region}}"
        stage: "{{stage_name}}"
        swagger_file: "./files/swagger.json"
        tracing_enabled: true
        state: present
   